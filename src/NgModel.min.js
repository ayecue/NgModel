/*!
 * @license NgModel for AngularJS
 * (c) 2015 AyeCue
 * License: MIT
 * This is inspired by:
 * ExtJS modellayer (https://docs.sencha.com/extjs/5.1/5.1.0-apidocs/#!/api/Ext.data.Model),
 * ActiveRecord (http://github.com/bfanger/angular-activerecord)
 */
angular.module("NgModel",[]).factory("NgModel",["$q","$http","$parse","$interpolate",function(t,e,r,n){function a(t,e,r){var n=this;angular.extend(n,{model:t,operation:e,options:r||{}}),n.initOptions()}function i(t,e){t&&angular.forEach(t,function(t,n){var a,i=d(e,n);o(i)&&(a=angular.isFunction(t)?t(i):r(n+"|"+t)(e),l(e,n,a))})}function o(t){return void 0!==t&&null!==t}function u(t,e){angular.forEach(t,function(r,n){t.hasOwnProperty(n)&&(angular.isFunction(r)&&(r.$previous=e[n]),e[n]=r)})}function s(t,e){var r=this[e]||this.callParent.caller||arguments.callee.caller||arguments.caller;if(!r){if(c())throw new Error('You are in strict mode use the second parameter in "callParent".');throw new Error('The method "callParent" failed because cannot identify caller.')}return r.$previous.apply(this,t)}function c(){return!this}function l(t,e,n){r(e).assign(t,n)}function d(t,e){return r(e)(t)}function p(t,e,r){var n=e.split("."),a=n.pop(),i=n.join("."),o=d(t,i);if(o[a]=null,delete o[a],r){for(var u in o)if(o.hasOwnProperty(u))return;p(t,i,r)}}function f(t){var e=this;e.response=null,e.data=angular.extend({},e.defaultData,t),e.initialize.apply(e,arguments)}return a.prototype={initOptions:function(){var t=this,e=t.model,r=t.options;return r.data=r.data||{},e.appendData[t.operation]&&(angular.extend(r.data,e.getRequestData()),angular.forEach(e.notPersist,function(t){p(r.data,t,!0)})),r.headers?angular.extend(r.headers,e.headers):r.headers=e.headers,r.method||(r.method=e.actionMethods[t.operation]),r.url||(r.url=e.buildUrl(t.operation,r)),r},isReading:function(){return"read"===this.operation},isWriting:function(){return"create"===this.operation||"update"===this.operation},get:function(){return this.options}},f.create=function(t,e){var r,n=this;return t=t||{},e=e||{},t.hasOwnProperty("constructor")?(r=t.constructor,t.constructor=null,delete t.constructor):r=function(){return n.apply(this,arguments)},r.constructor.$previous=n.constructor,r.prototype=Object.create(n.prototype),r.$super=n,angular.extend(r,n),u(t,r.prototype),u(e,r),r},f.fetchOne=function(t,e){var r=new this;return r.setId(t),r.fetch(e)},f.fetchAll=function(e){var r=this,n=new r,a=t.defer();return n.sync("read",n,e).then(function(t){var o,u,s=n.parse(t.data,e);angular.isArray(s)?(o=[],u=r.prototype.readFilters,angular.forEach(s,function(t){i(u,t),o.push(new r(t))}),a.resolve(o)):a.reject("Not a valid response, expecting an array")},a.reject),a.promise},f.callParent=s,f.prototype={idProperty:"id",defaultData:{},headers:{},resultRoot:null,url:null,readFilters:null,writeFilters:null,notPersist:[],actionMethods:{create:"POST",read:"GET",update:"PUT","delete":"DELETE"},api:{create:null,read:null,update:null,"delete":null},appendData:{create:!0,read:!1,update:!0,"delete":!1},initialize:function(t,e){var r=this;e=e||{},t&&(e.parse&&(t=r.parse(t)),e.readFilters&&i(r.readFilters,t),r.extend(t),r.previousProperties=function(){return t}),e.url&&(r.url=e.url)},hasChanged:function(t){var e=this,r=e.changedProperties();if(t)return t in r;for(var n in r)return!0;return!1},changedProperties:function(t){var e=this,r=t||e.data,n={},a=e.previousProperties();return o(t)||angular.forEach(a,function(t,e){o(t)||(n[e]=t)}),angular.forEach(r,function(t,e){r.hasOwnProperty(e)&&!angular.equals(t,a[e])==!1&&(n[e]=t)}),n},previous:function(t){var e=this,r=e.previousProperties();return d(r,t)},previousProperties:function(){return{}},fetch:function(e){var r=this,n=t.defer();return r.sync("read",r,e).then(function(t){var a=r.parse(t.data,e),o=t.status,u=400>o;r.response=t,u&&angular.isObject(a)?(i(r.readFilters,a),r.extend(a),r.previousProperties=function(){return a},n.resolve(r)):u?n.resolve(r):n.reject(r)},function(t){r.response=t,n.reject(r)}),n.promise},save:function(e){var r=this,n=r.isNew()?"create":"update",a=t.defer();return r.sync(n,r,e).then(function(t){var n=r.parse(t.data,e),o=t.status,u=400>o;r.response=t,u&&angular.isObject(n)?(i(r.readFilters,n),r.extend(n),r.previousProperties=function(){return n},a.resolve(r)):u?a.resolve(r):a.reject(r)},function(t){r.response=t,a.reject(r)}),a.promise},destroy:function(e){var r=this,n=t.defer();return r.isNew()?(n.resolve(r),n.promise):(r.sync("delete",r,e).then(function(t){r.response=t,n.resolve(r)},function(t){r.response=t,n.reject(r)}),n.promise)},sync:function(t,r,n){var o=this,u=new a(r,t,n);return n=u.get(),u.isWriting()&&i(o.writeFilters,n.data),e(n)},buildUrl:function(t,e){var r=this,a=r.api[t]||r.url,i=angular.extend({},r.data,e.data),u=n(a)(i);if(!o(i[r.idProperty]))return u;if(!o(u))throw"Implement this.buildUrl() or specify this.url";return n("{{root}}{{end}}{{id}}")({root:u,end:"/"===u.charAt(u.length-1)?"":"/",id:encodeURIComponent(i[r.idProperty])})},parse:function(t){return o(this.resultRoot)?d(t,this.resultRoot):t},isNew:function(){return!o(this.getId())},toJSON:function(){return this.data},toScope:function(t,e){return t[e]=this.data,this},getRequestData:function(){return this.data},getId:function(){return this.data[this.idProperty]},setId:function(t){return this.data[this.idProperty]=t,this},get:function(t){return d(this.data,t)},set:function(t,e){return l(this.data,t,e),this},range:function(){var t=this,e={};return angular.forEach(arguments,function(r){var n=r,a=r;angular.isObject(r)&&(n=r.from,a=r.to),e[n]=t.data[a]}),e},extend:function(t){return angular.extend(this.data,t),this},callParent:s},f}]);