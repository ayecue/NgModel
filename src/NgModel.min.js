//@license NgModel for AngularJS, (c) 2015 AyeCue, License: MIT
angular.module("NgModel",[]).factory("NgModel",["$q","$http","$parse","$interpolate",function($q,$http,$parse,$interpolate){function Batch(model,operation,options){var me=this;angular.extend(me,{model:model,operation:operation,options:options||{}}),me.initOptions()}function applyFilters(filters,properties){filters&&angular.forEach(filters,function(filter,namespace){var newValue,value=getNamespace(properties,namespace);isDefined(value)&&(newValue=angular.isFunction(filter)?filter(value):$parse(namespace+"|"+filter)(properties),setNamespace(properties,namespace,newValue))})}function isDefined(obj){return void 0!==obj&&null!==obj}function extendTo(properties,to){angular.forEach(properties,function(value,key){properties.hasOwnProperty(key)&&(angular.isFunction(value)&&(value.$previous=to[key]),to[key]=value)})}function callParent(args,method){var caller=this[method]||this.callParent.caller||arguments.callee.caller||arguments.caller;if(!caller){if(isStrict())throw new Error('You are in strict mode use the second parameter in "callParent".');throw new Error('The method "callParent" failed because cannot identify caller.')}return caller.$previous.apply(this,args)}function isStrict(){return!this}function setNamespace(obj,id,value){$parse(id).assign(obj,value)}function getNamespace(obj,id){return $parse(id)(obj)}function removeNamespace(obj,id,autoDelete){var parts=id.split("."),last=parts.pop(),pre=parts.join("."),root=getNamespace(obj,pre);if(root[last]=null,delete root[last],autoDelete){for(var key in root)if(root.hasOwnProperty(key))return;removeNamespace(obj,pre,autoDelete)}}function NgModel(properties){var me=this;me.response=null,me.data=angular.extend({},me.defaultData,properties),me.initialize.apply(me,arguments)}return Batch.prototype={initOptions:function(){var me=this,model=me.model,options=me.options;return options.data=options.data||{},model.appendData[me.operation]&&(angular.extend(options.data,model.getRequestData()),angular.forEach(model.notPersist,function(toExclude){removeNamespace(options.data,toExclude,!0)})),options.headers?angular.extend(options.headers,model.headers):options.headers=model.headers,options.method||(options.method=model.actionMethods[me.operation]),options.url||(options.url=model.buildUrl(me.operation,options)),options},isReading:function(){return"read"===this.operation},isWriting:function(){return"create"===this.operation||"update"===this.operation},get:function(){return this.options}},NgModel.create=function(properties,statics){var sub,extend=this;return properties=properties||{},statics=statics||{},properties.hasOwnProperty("constructor")?(sub=properties.constructor,properties.constructor=null,delete properties.constructor):sub=function(){return extend.apply(this,arguments)},sub.constructor.$previous=extend.constructor,sub.prototype=Object.create(extend.prototype),sub.$super=extend,angular.extend(sub,extend),extendTo(properties,sub.prototype),extendTo(statics,sub),sub},NgModel.fetchOne=function(id,options){var model=new this;return model.setId(id),model.fetch(options)},NgModel.fetchAll=function(options){var model=this,instance=new model,deferred=$q.defer();return instance.sync("read",instance,options).then(function(response){var models,filters,data=instance.parse(response.data,options);angular.isArray(data)?(models=[],filters=model.prototype.readFilters,angular.forEach(data,function(item){applyFilters(filters,item),models.push(new model(item))}),deferred.resolve(models)):deferred.reject("Not a valid response, expecting an array")},deferred.reject),deferred.promise},NgModel.callParent=callParent,NgModel.prototype={idProperty:"id",defaultData:{},headers:{},resultRoot:null,url:null,readFilters:null,writeFilters:null,notPersist:[],actionMethods:{create:"POST",read:"GET",update:"PUT","delete":"DELETE"},api:{create:null,read:null,update:null,"delete":null},appendData:{create:!0,read:!1,update:!0,"delete":!1},initialize:function(properties,options){var me=this;options=options||{},properties&&(options.parse&&(properties=me.parse(properties)),options.readFilters&&applyFilters(me.readFilters,properties),me.extend(properties),me.previousProperties=function(){return properties}),options.url&&(me.url=options.url)},hasChanged:function(property){var me=this,changed=me.changedProperties();if(property)return property in changed;for(var i in changed)return!0;return!1},changedProperties:function(diff){var me=this,current=diff||me.data,changed={},previousProperties=me.previousProperties();return isDefined(diff)||angular.forEach(previousProperties,function(value,property){isDefined(value)||(changed[property]=value)}),angular.forEach(current,function(value,property){current.hasOwnProperty(property)&&!angular.equals(value,previousProperties[property])==!1&&(changed[property]=value)}),changed},previous:function(property){var me=this,previous=me.previousProperties();return getNamespace(previous,property)},previousProperties:function(){return{}},fetch:function(options){var me=this,deferred=$q.defer();return me.sync("read",me,options).then(function(response){var data=me.parse(response.data,options),status=response.status,success=400>status;me.response=response,success&&angular.isObject(data)?(applyFilters(me.readFilters,data),me.extend(data),me.previousProperties=function(){return data},deferred.resolve(me)):success?deferred.resolve(me):deferred.reject(me)},function(response){me.response=response,deferred.reject(me)}),deferred.promise},save:function(options){var me=this,operation=me.isNew()?"create":"update",deferred=$q.defer();return me.sync(operation,me,options).then(function(response){var data=me.parse(response.data,options),status=response.status,success=400>status;me.response=response,success&&angular.isObject(data)?(applyFilters(me.readFilters,data),me.extend(data),me.previousProperties=function(){return data},deferred.resolve(me)):success?deferred.resolve(me):deferred.reject(me)},function(response){me.response=response,deferred.reject(me)}),deferred.promise},destroy:function(options){var me=this,deferred=$q.defer();return me.isNew()?(deferred.resolve(me),deferred.promise):(me.sync("delete",me,options).then(function(response){me.response=response,deferred.resolve(me)},function(response){me.response=response,deferred.reject(me)}),deferred.promise)},sync:function(operation,model,options){var me=this,batch=new Batch(model,operation,options);return options=batch.get(),batch.isWriting()&&applyFilters(me.writeFilters,options.data),$http(options)},buildUrl:function(operation,options){var me=this,url=me.api[operation]||me.url,data=angular.extend({},me.data,options.data),formatedUrl=$interpolate(url)(data);if(!isDefined(data[me.idProperty]))return formatedUrl;if(!isDefined(formatedUrl))throw"Implement this.buildUrl() or specify this.url";return $interpolate("{{root}}{{end}}{{id}}")({root:formatedUrl,end:"/"===formatedUrl.charAt(formatedUrl.length-1)?"":"/",id:encodeURIComponent(data[me.idProperty])})},parse:function(data,options){return isDefined(this.resultRoot)?getNamespace(data,this.resultRoot):data},isNew:function(){return!isDefined(this.getId())},toJSON:function(){return this.data},toScope:function(scope,key){return scope[key]=this.data,this},getRequestData:function(){return this.data},getId:function(){return this.data[this.idProperty]},setId:function(id){return this.data[this.idProperty]=id,this},get:function(key){return getNamespace(this.data,key)},set:function(key,value){return setNamespace(this.data,key,value),this},range:function(){var me=this,result={};return angular.forEach(arguments,function(item){var from=item,to=item;angular.isObject(item)&&(from=item.from,to=item.to),result[from]=me.data[to]}),result},extend:function(data){return angular.extend(this.data,data),this},callParent:callParent},NgModel}]);