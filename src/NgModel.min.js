/*!
 * @license NgModel for AngularJS
 * (c) 2015 AyeCue
 * License: MIT
 * This is inspired by:
 * ExtJS modellayer (https://docs.sencha.com/extjs/5.1/5.1.0-apidocs/#!/api/Ext.data.Model),
 * ActiveRecord (http://github.com/bfanger/angular-activerecord)
 */
angular.module("NgModel",[]).factory("Batch",["Namespace",function(t){function e(t,e,r){var n=this;angular.extend(n,{model:t,operation:e,options:r||{}}),n.initOptions()}return e.prototype={initOptions:function(){var e=this,r=e.model,n=e.options;return n.data=n.data||{},r.appendData[e.operation]&&(angular.extend(n.data,r.getRequestData()),angular.forEach(r.notPersist,function(e){t.remove(n.data,e,!0)})),n.headers?angular.extend(n.headers,r.headers):n.headers=r.headers,n.method||(n.method=r.actionMethods[e.operation]),n.url||(n.url=r.buildUrl(e.operation,n)),n},isReading:function(){return"read"===this.operation},isWriting:function(){return"create"===this.operation||"update"===this.operation},get:function(){return this.options}},e}]).factory("Namespace",["$parse",function(t){return{delimiter:".",set:function(e,r,n){t(r).assign(e,n)},get:function(e,r){return t(r)(e)},remove:function(t,e,r){var n=this,a=e.split(n.delimiter),i=a.pop(),o=a.join(n.delimiter),u=n.get(t,o);if(u[i]=null,delete u[i],r){for(var s in u)if(u.hasOwnProperty(s))return;n.remove(t,o,r)}}}}]).factory("NgModel",["$q","$http","$parse","$interpolate","Namespace","Batch",function(t,e,r,n,a,i){function o(t){var e=this;e.response=null,e.data=angular.extend({},e.defaultData,t),e.initialize.apply(e,arguments)}function u(t,e){t&&angular.forEach(t,function(t,n){var i,o=a.get(e,n);s(o)&&(i=angular.isFunction(t)?t(o):r(n+"|"+t)(e),a.set(e,n,i))})}function s(t){return void 0!==t&&null!==t}function c(t,e){angular.forEach(t,function(r,n){t.hasOwnProperty(n)&&(angular.isFunction(r)&&(r.$previous=e[n]),e[n]=r)})}function l(t,e){var r=this[e]||this.callParent.caller||arguments.callee.caller||arguments.caller;if(!r){if(d())throw new Error('You are in strict mode use the second parameter in "callParent".');throw new Error('The method "callParent" failed because cannot identify caller.')}return r.$previous.apply(this,t)}function d(){return!this}return o.create=function(t,e){var r,n=this;return t=t||{},e=e||{},t.hasOwnProperty("constructor")?(r=t.constructor,t.constructor=null,delete t.constructor):r=function(){return n.apply(this,arguments)},r.constructor.$previous=n.constructor,r.prototype=new n,r.$super=n,c(t,r.prototype),c(n,r),c(e,r),r},o.fetchOne=function(t,e){var r=new this;return r.setId(t),r.fetch(e)},o.fetchAll=function(e){var r=this,n=new r,a=t.defer();n.sync("read",n,e).then(function(t){var i,o,s=n.parse(t.data,e);angular.isArray(s)?(i=[],o=r.prototype.readFilters,angular.forEach(s,function(t){u(o,t),i.push(new r(t))}),a.resolve(i)):a.reject("Not a valid response, expecting an array")},a.reject)},o.callParent=l,o.prototype={idProperty:"id",defaultData:{},headers:{},resultRoot:null,url:null,readFilters:null,writeFilters:null,notPersist:[],actionMethods:{create:"POST",read:"GET",update:"PUT","delete":"DELETE"},api:{create:null,read:null,update:null,"delete":null},appendData:{create:!0,read:!1,update:!0,"delete":!1},initialize:function(t,e){var r=this;e=e||{},t&&(e.parse&&(t=r.parse(t)),e.readFilters&&u(r.readFilters,t),r.extend(t),r.previousAttributes=function(){return t}),e.url&&(r.url=e.url)},hasChanged:function(t){var e=this,r=e.changedProperties();if(t)return t in r;for(var n in r)return!0;return!1},changedProperties:function(t){var e=this,r=t||e.data,n={},a=e.previousAttributes();return s(t)||angular.forEach(a,function(t,e){s(t)||(n[e]=t)}),angular.forEach(r,function(t,e){r.hasOwnProperty(e)&&0==!angular.equals(t,a[e])&&(n[e]=t)}),n},previous:function(t){var e=this,r=e.previousAttributes();return a.get(r,t)},previousAttributes:function(){return{}},fetch:function(e){var r=this,n=t.defer();return r.sync("read",r,e).then(function(t){var a=r.parse(t.data,e),i=t.status,o=400>i;r.response=t,o&&angular.isObject(a)?(u(r.readFilters,a),r.extend(a),r.previousAttributes=function(){return a},n.resolve(r)):o?n.resolve(r):n.reject(r)},function(t){r.response=t,n.reject(r)}),n.promise},save:function(e){var r=this,n=r.isNew()?"create":"update",a=t.defer();return r.sync(n,r,e).then(function(t){var n=r.parse(t.data,e),i=t.status,o=400>i;r.response=t,o&&angular.isObject(n)?(u(r.readFilters,n),r.extend(n),r.previousAttributes=function(){return n},a.resolve(r)):o?a.resolve(r):a.reject(r)},function(t){r.response=t,a.reject(r)}),a.promise},destroy:function(e){var r=this,n=t.defer();return r.isNew()?(n.resolve(),n.promise):(this.sync("delete",this,e).then(function(t){r.response=t,n.resolve()},function(t){r.response=t,n.reject(r)}),n.promise)},sync:function(t,r,n){var a=this,o=new i(r,t,n);return n=o.get(),o.isWriting()&&u(a.writeFilters,n.data),e(n)},buildUrl:function(t,e){var r=this,a=r.api[t]||r.url,i=angular.extend({},r.data,e.data),o=n(a)(i);if(!s(i[r.idProperty]))return o;if(!s(o))throw"Implement this.buildUrl() or specify this.url";return n("{{root}}{{end}}{{id}}")({root:o,end:"/"===o.charAt(o.length-1)?"":"/",id:encodeURIComponent(i[r.idProperty])})},parse:function(t){return s(this.resultRoot)?a.get(t,this.resultRoot):t},isNew:function(){return null==this.getId()},toJSON:function(){return this.data},toScope:function(t,e){return t[e]=this.data,this},getRequestData:function(){return this.data},getId:function(){return this.data[this.idProperty]},setId:function(t){return this.data[this.idProperty]=t,this},get:function(t){return a.get(this.data,t)},set:function(t,e){return a.set(this.data,t,e),this},range:function(){var t=this,e={};return angular.forEach(arguments,function(r){var n=r,a=r;angular.isObject(r)&&(n=r.from,a=r.to),e[n]=t.data[a]}),e},extend:function(t){return angular.extend(this.data,t),this},callParent:l},o}]);