/*!
 * @license NgModel for AngularJS
 * (c) 2015 AyeCue
 * License: MIT
 * This is inspired by:
 * ExtJS modellayer (https://docs.sencha.com/extjs/5.1/5.1.0-apidocs/#!/api/Ext.data.Model),
 * ActiveRecord (http://github.com/bfanger/angular-activerecord)
 */
angular.module("NgModel",[]).factory("NgModel",["$q","$http","$parse","$interpolate",function(t,e,r,n){function a(t,e,r){var n=this;angular.extend(n,{model:t,operation:e,options:r||{}}),n.initOptions()}function i(t){var e=this;e.response=null,e.data=angular.extend({},e.defaultData,t),e.initialize.apply(e,arguments)}function o(t,e){t&&angular.forEach(t,function(t,n){var a,i=p(e,n);u(i)&&(a=angular.isFunction(t)?t(i):r(n+"|"+t)(e),d(e,n,a))})}function u(t){return void 0!==t&&null!==t}function s(t,e){angular.forEach(t,function(r,n){t.hasOwnProperty(n)&&(angular.isFunction(r)&&(r.$previous=e[n]),e[n]=r)})}function c(t,e){var r=this[e]||this.callParent.caller||arguments.callee.caller||arguments.caller;if(!r){if(l())throw new Error('You are in strict mode use the second parameter in "callParent".');throw new Error('The method "callParent" failed because cannot identify caller.')}return r.$previous.apply(this,t)}function l(){return!this}function d(t,e,n){r(e).assign(t,n)}function p(t,e){return r(e)(t)}function f(t,e,r){var n=e.split("."),a=n.pop(),i=n.join("."),o=p(t,i);if(o[a]=null,delete o[a],r){for(var u in o)if(o.hasOwnProperty(u))return;f(t,i,r)}}return a.prototype={initOptions:function(){var t=this,e=t.model,r=t.options;return r.data=r.data||{},e.appendData[t.operation]&&(angular.extend(r.data,e.getRequestData()),angular.forEach(e.notPersist,function(t){f(r.data,t,!0)})),r.headers?angular.extend(r.headers,e.headers):r.headers=e.headers,r.method||(r.method=e.actionMethods[t.operation]),r.url||(r.url=e.buildUrl(t.operation,r)),r},isReading:function(){return"read"===this.operation},isWriting:function(){return"create"===this.operation||"update"===this.operation},get:function(){return this.options}},i.create=function(t,e){var r,n=this;return t=t||{},e=e||{},t.hasOwnProperty("constructor")?(r=t.constructor,t.constructor=null,delete t.constructor):r=function(){return n.apply(this,arguments)},r.constructor.$previous=n.constructor,r.prototype=Object.create(n.prototype),r.$super=n,angular.extend(r,n),s(t,r.prototype),s(e,r),r},i.fetchOne=function(t,e){var r=new this;return r.setId(t),r.fetch(e)},i.fetchAll=function(e){var r=this,n=new r,a=t.defer();return n.sync("read",n,e).then(function(t){var i,u,s=n.parse(t.data,e);angular.isArray(s)?(i=[],u=r.prototype.readFilters,angular.forEach(s,function(t){o(u,t),i.push(new r(t))}),a.resolve(i)):a.reject("Not a valid response, expecting an array")},a.reject),a.promise},i.callParent=c,i.prototype={idProperty:"id",defaultData:{},headers:{},resultRoot:null,url:null,readFilters:null,writeFilters:null,notPersist:[],actionMethods:{create:"POST",read:"GET",update:"PUT","delete":"DELETE"},api:{create:null,read:null,update:null,"delete":null},appendData:{create:!0,read:!1,update:!0,"delete":!1},initialize:function(t,e){var r=this;e=e||{},t&&(e.parse&&(t=r.parse(t)),e.readFilters&&o(r.readFilters,t),r.extend(t),r.previousAttributes=function(){return t}),e.url&&(r.url=e.url)},hasChanged:function(t){var e=this,r=e.changedProperties();if(t)return t in r;for(var n in r)return!0;return!1},changedProperties:function(t){var e=this,r=t||e.data,n={},a=e.previousAttributes();return u(t)||angular.forEach(a,function(t,e){u(t)||(n[e]=t)}),angular.forEach(r,function(t,e){r.hasOwnProperty(e)&&!angular.equals(t,a[e])==!1&&(n[e]=t)}),n},previous:function(t){var e=this,r=e.previousAttributes();return p(r,t)},previousAttributes:function(){return{}},fetch:function(e){var r=this,n=t.defer();return r.sync("read",r,e).then(function(t){var a=r.parse(t.data,e),i=t.status,u=400>i;r.response=t,u&&angular.isObject(a)?(o(r.readFilters,a),r.extend(a),r.previousAttributes=function(){return a},n.resolve(r)):u?n.resolve(r):n.reject(r)},function(t){r.response=t,n.reject(r)}),n.promise},save:function(e){var r=this,n=r.isNew()?"create":"update",a=t.defer();return r.sync(n,r,e).then(function(t){var n=r.parse(t.data,e),i=t.status,u=400>i;r.response=t,u&&angular.isObject(n)?(o(r.readFilters,n),r.extend(n),r.previousAttributes=function(){return n},a.resolve(r)):u?a.resolve(r):a.reject(r)},function(t){r.response=t,a.reject(r)}),a.promise},destroy:function(e){var r=this,n=t.defer();return r.isNew()?(n.resolve(r),n.promise):(r.sync("delete",r,e).then(function(t){r.response=t,n.resolve(r)},function(t){r.response=t,n.reject(r)}),n.promise)},sync:function(t,r,n){var i=this,u=new a(r,t,n);return n=u.get(),u.isWriting()&&o(i.writeFilters,n.data),e(n)},buildUrl:function(t,e){var r=this,a=r.api[t]||r.url,i=angular.extend({},r.data,e.data),o=n(a)(i);if(!u(i[r.idProperty]))return o;if(!u(o))throw"Implement this.buildUrl() or specify this.url";return n("{{root}}{{end}}{{id}}")({root:o,end:"/"===o.charAt(o.length-1)?"":"/",id:encodeURIComponent(i[r.idProperty])})},parse:function(t){return u(this.resultRoot)?p(t,this.resultRoot):t},isNew:function(){return null==this.getId()},toJSON:function(){return this.data},toScope:function(t,e){return t[e]=this.data,this},getRequestData:function(){return this.data},getId:function(){return this.data[this.idProperty]},setId:function(t){return this.data[this.idProperty]=t,this},get:function(t){return p(this.data,t)},set:function(t,e){return d(this.data,t,e),this},range:function(){var t=this,e={};return angular.forEach(arguments,function(r){var n=r,a=r;angular.isObject(r)&&(n=r.from,a=r.to),e[n]=t.data[a]}),e},extend:function(t){return angular.extend(this.data,t),this},callParent:c},i}]);